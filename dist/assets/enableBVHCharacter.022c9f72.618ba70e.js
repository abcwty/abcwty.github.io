import{u as Z,v as w,Z as z,F as G,w as k,P as H,y as $,B as U,C,D as E,E as W,G as j,L,M as P,S as Q,Q as X,T as _,W as A,H as D,k as I,U as J}from"./index.66975801.js";import{s as R}from"./useBVHMap.37f7c48f.6f03e93c.js";import{s as T,p as Y}from"./bvhManagerMap.fa3f08c1.bebd7d59.js";import{x as V}from"./PhysicsUpdate.0a7e4cd0.02fb49e3.js";const v=new Set,q=()=>new WeakSet;Z(function(){if(k()||!H()||T())return;const n=R();if(!n.length)return;const e=w(),x=z(),d=.02,c=G(),B=$(()=>{U.clear();for(const t of v){const s=t.bvhVelocity,o=t.outerObject3d,l=t.bvhHalfHeight,i=c?l:t.bvhRadius;c?s.add(t.bvhOnGround||t._gravity===!1?C:E(o).normalize().multiplyScalar(d*-e*W[0])):s.y+=t.bvhOnGround||t._gravity===!1?0:d*-e*W[0];const h=t.positionUpdate;h.x&&(s.x=0),h.y&&(s.y=0),h.z&&(s.z=0),h.reset(),o.position.addScaledVector(s,d),o.updateMatrixWorld();const{start:r,end:p}=P;p.copy(r.copy(o.position));const S=Math.max(l-i,0);p.y+=S,r.y-=S;const F=r.clone();j.setFromCenterAndSize(o.position,L.set(i*2,l*2,i*2));const g=I,O=J;let u=0,m,y=!1,b;for(const M of n)b=Y.get(M),M.shapecast({intersectsBounds:f=>f.intersectsBox(j),intersectsTriangle:f=>{u=f.closestPointToSegment(P,g,O),u<i&&(y=!0,m=O.sub(g).normalize().multiplyScalar(i-u),r.add(m),p.add(m))}});y&&b&&Q(U,t,q).add(b);const a=r.sub(F);c?t.bvhOnGround=y:(t.bvhOnGround=a.y>Math.abs(d*s.y*.25),x&&t.bvhOnGround&&Math.abs(a.y/(a.x+a.z+Number.EPSILON))<x&&(t.bvhOnGround=!1));const N=Math.max(0,a.length()-1e-5);a.normalize().multiplyScalar(N),o.position.add(a),t.bvhOnGround?s.set(0,0,0):(a.normalize(),s.addScaledVector(a,-a.dot(s)))}});return()=>{B.cancel()}},[R,w,z,G,k,H,T]);function ot(n){if(n.done)return;X.attach(this.outerObject3d),this instanceof _&&(this.width=this.depth=Math.min(this.width,this.depth)),this.rotationUpdate=new V,this.positionUpdate=new V;const e=A(this).multiplyScalar(.5);this.bvhHalfHeight=Math.max(e.y,.5),this.bvhRadius=Math.max(e.x,.5),this.bvhVelocity=new D,v.add(this),n.then(()=>{v.delete(this),this.rotationUpdate=void 0,this.positionUpdate=void 0})}export{ot as default};
