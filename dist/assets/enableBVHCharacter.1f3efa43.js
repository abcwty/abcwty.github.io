import{cY as E,cZ as G,c_ as V,c$ as z,d0 as H,d1 as P,cz as T,d2 as w,d3 as F,cG as L,d4 as _,d5 as B,d6 as N,d7 as C,bS as I,d8 as K,d9 as Y,cy as Z,cm as $,da as q,bK as D}from"./index.66975801.js";import{g as R,c as U,b as J}from"./bvhManagerMap.cd08c8fd.js";import{P as W}from"./PhysicsUpdate.424dc14a.js";const m=new Set,Q=()=>new WeakSet;E(function(){if(H()||!P()||U())return;const o=R();if(!o.length)return;const n=G(),v=V(),r=.02,l=z(),j=T(()=>{w.clear();for(const t of m){const e=t.bvhVelocity,s=t.outerObject3d,h=t.bvhHalfHeight,i=l?h:t.bvhRadius;l?e.add(t.bvhOnGround||t._gravity===!1?F:L(s).normalize().multiplyScalar(r*-n*_[0])):e.y+=t.bvhOnGround||t._gravity===!1?0:r*-n*_[0];const d=t.positionUpdate;d.x&&(e.x=0),d.y&&(e.y=0),d.z&&(e.z=0),d.reset(),s.position.addScaledVector(e,r),s.updateMatrixWorld();const{start:c,end:p}=C;p.copy(c.copy(s.position));const S=Math.max(h-i,0);p.y+=S,c.y-=S;const k=c.clone();B.setFromCenterAndSize(s.position,N.set(i*2,h*2,i*2));const M=K,O=Y;let u=0,f,b=!1,y;for(const x of o)y=J.get(x),x.shapecast({intersectsBounds:g=>g.intersectsBox(B),intersectsTriangle:g=>{u=g.closestPointToSegment(C,M,O),u<i&&(b=!0,f=O.sub(M).normalize().multiplyScalar(i-u),c.add(f),p.add(f))}});b&&y&&I(w,t,Q).add(y);const a=c.sub(k);l?t.bvhOnGround=b:(t.bvhOnGround=a.y>Math.abs(r*e.y*.25),v&&t.bvhOnGround&&Math.abs(a.y/(a.x+a.z+Number.EPSILON))<v&&(t.bvhOnGround=!1));const A=Math.max(0,a.length()-1e-5);a.normalize().multiplyScalar(A),s.position.add(a),t.bvhOnGround?e.set(0,0,0):(a.normalize(),e.addScaledVector(a,-a.dot(e)))}});return()=>{j.cancel()}},[R,G,V,z,H,P,U]);function at(o){if(o.done)return;Z.attach(this.outerObject3d),this instanceof $&&(this.width=this.depth=Math.min(this.width,this.depth)),this.rotationUpdate=new W,this.positionUpdate=new W;const n=q(this).multiplyScalar(.5);this.bvhHalfHeight=Math.max(n.y,.5),this.bvhRadius=Math.max(n.x,.5),this.bvhVelocity=new D,m.add(this),o.then(()=>{m.delete(this),this.rotationUpdate=void 0,this.positionUpdate=void 0})}export{at as default};
